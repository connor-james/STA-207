---
title: "Capturing effects of class sizes with classroom performacne"
author: "Connor Rosenberg"
date: "1/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
#Required Packages

library("AER")
library("ggplot2")
library("car")
library("dplyr")
library("plotly")
library("MASS")
library("knitr")
library("tidyr")
```

```{r, include=FALSE}
#Prepare Data

data("STAR")

star = data.frame( "gender" = STAR$gender, "ethnicity" = STAR$ethnicity, "star1" = STAR$star1, "math1" = STAR$math1)

star_k = data.frame( "gender" = STAR$gender, "ethnicity" = STAR$ethnicity, "star.k" = STAR$stark, "math.k" = STAR$mathk)


star = star[complete.cases(star),] #Eliminate all cases w/ NA

star_k = star_k[complete.cases(star_k),]
```

```{r}
View(star_k)
```


```{r, include=FALSE}
#Check data & objects

#str(star)

star$gender = as.factor(star$gender)
star$ethnicity = as.factor(star$ethnicity)
star$star1 = as.factor(star$star1)



```


```{r, include= FALSE}
#Set colors for pretty pictures

color2 = c("#FF6868", "#54B7FF")
color3 = c("#FF6868", "#54B7FF", "97FF68")
color4 = c("#FF6868", "#54B7FF", "97FF68", "#A168FF")
color5 = c("#FF6868", "#54B7FF", "97FF68", "#A168FF", "#FFB768")
color5 = c("#FF6868", "#54B7FF", "97FF68", "#A168FF", "#FFB768", "#FFE068")
 

#NOTE: colors will be assigned to factors in alphabetical order
```


```{r, include=FALSE}
#Task 2 Summary Statistics:
#NOTE: Please save all figures as objects to be called later in the report
#NOTE: Use plotly package to make everything consistant https://plot.ly/r

summary(star)

#Piechart of Gender
count = data.frame(table(star$gender))
pieGender = plot_ly(count, labels = ~Var1, values = ~Freq, type = 'pie') %>%
  layout(title = "Gender of Participating Studnets")
pieGender

# Piechart of star1
count2 = data.frame(table(star$star1))
pieStar1 = plot_ly(count2, labels = ~Var1, values = ~Freq, type = 'pie') %>%
  layout(title = "Class Type of 1st Grade")
pieStar1

# Bar Graph of star1

counts3 <- table(star$star1)
barplot(counts3, main="Distribution of 1st Grade Class Type", 
   xlab="Class Type", col=c("darkblue","red","green"))

#Plot of boxplot of math scores broken by class type
box1 = plot_ly(star, y = ~math1, color = ~star1, type = "box")
box1







```
From the pie chart of Gender, we can see that the numbers of males is 3414 and the number of females is 3184.




```{r, include = FALSE}
# Task 2

table(star$star1)

mean(subset(star, star1 == "small")[["math1"]])
mean(subset(star, star1 == "regular")[["math1"]])
mean(subset(star, star1 == "regular+aide")[["math1"]])

var(subset(star, star1 == "small")[["math1"]])
var(subset(star, star1 == "regular")[["math1"]])
var(subset(star, star1 == "regular+aide")[["math1"]])

```


```{r, include = FALSE}
## School type
boxSchool = STAR %>% 
  dplyr::select(school1, math1) %>% 
  na.omit() %>% 
  plot_ly(x = ~school1, 
          y = ~math1,
          color = ~school1,
          type = "box") %>% 
  layout(title = "Total Math Scaled Score in 1st Grade for Differnt types of School") %>% 
  layout(yaxis = list(title = "Total Math Scaled Score in 1st Grade"), 
         xaxis = list(title = "School Type"))
boxSchool

barSchool = STAR %>% 
  dplyr::select(school1, math1, star1) %>% 
  na.omit() %>%
  group_by(school1, star1) %>% 
  summarise(math = median(math1)) %>% 
  plot_ly(x = ~school1, 
          y = ~math,
          color = ~star1,
          type = "bar") %>% 
  layout(title = "Median of Total Math Scaled Score in 1st Grade") %>% 
  layout(yaxis = list(title = "Total Math Scaled Score in 1st Grade"), 
         xaxis = list(title = "School Type"))
barSchool


## grade
lineMath = STAR %>% 
  dplyr::select(stark, mathk, star1, math1, star2, math2, star3, math3) %>% 
  filter(stark == star1 & stark == star2 & stark == star3) %>%
  #na.omit() %>% 
  group_by(class_type = stark) %>%
  summarise(kindergarten = mean(mathk, na.rm = TRUE),
            grade1 = mean(math1, na.rm = TRUE),
            grade2 = mean(math2, na.rm = TRUE),
            grade3 = mean(math3, na.rm = TRUE)) %>% 
  pivot_longer(-class_type, names_to = 'math', values_to = 'grade') %>% 
  plot_ly(y = ~grade, 
          x = ~factor(math, level = c('kindergarten','grade1','grade2','grade3')),
          color = ~class_type,
          type = "scatter",
          mode = "lines") %>% 
  layout(title = "Mean of Total Math Scaled Score") %>% 
  layout(xaxis = list(title = 'Grade'),
         yaxis = list(title = 'Total Math Scaled Score'))

lineMath
```


```{r, include=FALSE}
#Task 4
```


```{r, include = FALSE}
#Fitting the model

# Test for variance homogeneity
leveneTest(math1~star1, data = star) #Equal Variacnes


#One-Way ANOVA for STAR1
reg1 = lm(math1~star1, data = star)
summary(reg1)
anova1 = anova(reg1)
anova1
boxplot(star$math1~star$star1)

plot(reg1,2)
plot(reg1, which = c(1,2))

boxcox(reg1)


#Plot of boxplot of math scores broken by class type
box1 = plot_ly(star, y = ~math1, color = ~star1, type = "box")
box1
```


```{r}
# Task 7
reg2 = lm(math.k~star.k, data = star_k)
anova2 = anova(reg2)
anova2

```


```{r, include = FALSE}
# test
alpha = 0.05
r = 3
nt = dim(star)[1]

## F-test
fit1 = aov(math1~star1, data = star)
summary(fit1)



ni = as.numeric(summary(star$star1))
mstr = 97444
mse = sum(fit1$residuals^2)/(nt-r)
f = mstr/mse
f_cr = qf(1-alpha, r-1, nt-r)
f > f_cr

## family-wise ci
y_bar = as.numeric(tapply(star$math1, star$star1, mean))
y_bar

d1 = y_bar[1] - y_bar[2]
d2 = y_bar[2] - y_bar[3]
d3 = y_bar[3] - y_bar[1]

s_d1 = sqrt(mse*(1/ni[1]+1/ni[2]))
s_d2 = sqrt(mse*(1/ni[2]+1/ni[3]))
s_d3 = sqrt(mse*(1/ni[3]+1/ni[1]))


g = 3
B_ = qt(1-alpha/(2*g), nt-r)                         
T_ = 1/sqrt(2) * qtukey(1-alpha, r, nt-r)  # smallest, use tukey
S_ = sqrt((r-1) * qf(1-alpha, r, nt-r))

ci1 = c(d1-s_d1*T_, d1+s_d1*T_)
ci2 = c(d2-s_d2*T_, d2+s_d2*T_)
ci3 = c(d3-s_d3*T_, d3+s_d3*T_)

```

```{r, include = FALSE}
#Write the reprt below
```



# Introduction

## Background

## Questions of Interest

1. Is there a significant difference in the mean math scores in the 1st grade across different class types?
2. Are the assumptions of the ANOVA model satisfied? To explore this question, we will use model diagnostics such as residual plots and a Levene test for equality of variances.
3. Is there a significant difference in the mean math scores in kindergarten across different class types?

#Methods & Analysis

## Descriptive Analysis

### School Type
The project include four types of schools to assess the effects of class size in differnet school locations. They are inner-city, suburban, urban, and rural schools. Inner-city and surburban schools were located in metropolitan areas, and urban or rural schools were located in non-metropolitan areas. 

According to the box plot, students in suburban and rural schools
performed better on the total math scaled score in 1st grade. Besides, the bar plot shows that in all types of schools, students in small classes performed slightly better than students in regular classes or regular classes with a full-time teacher aide. However, the effect of school type is not very significant in this plot, and further analysis might be needed.

### Class type
Considering that some schools might drop out of the project, or the class type might be changed if schools gain or lose students, here I only select students that had full records of math scaled scores, and remained in the same type of class from kindergarten to the 3rd grade.

According to the line plot, the performance of students in regular classes and the performance of students in regular classes with a full-time tearcher aide are not very different. However, the students in small classes performed better on the total math scaled score from kindergarten to the 3rd grade.
